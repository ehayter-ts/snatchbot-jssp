{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["import '@k2oss/k2-broker-core';\n\nmetadata = {\n    systemName: \"SnatchBot_ChatBot\",\n    displayName: \"SnatchBot ChatBot\",\n    description: \"SnatchBot ChatBot\",\n    configuration: {}\n};\n\nondescribe = async function ({ }): Promise<void> {\n    postSchema({\n        objects: {\n            \"message\": {\n                displayName: \"Message\",\n                description: \"Represent a text reply\",\n                properties: {\n                    \"botURL\": {\n                        displayName: \"Bot URL\",\n                        type: \"string\"\n                    },\n                    \"inputText\": {\n                        displayName: \"Input Text\",\n                        type: \"string\"\n                    },\n                    \"outputText\": {\n                        displayName: \"Output Text\",\n                        type: \"string\"\n                    },\n                    \"userID\": {\n                        displayName: \"User ID\",\n                        type: \"string\"\n                    }\n                },\n                methods: {\n                    \"postText\": {\n                        displayName: \"Post Text\",\n                        type: \"execute\",\n                        inputs: [\"botURL\", \"inputText\", \"userID\"],\n                        outputs: [\"outputText\"]\n                    },\n                    \"startChat\": {\n                        displayName: \"Start Chat\",\n                        type: \"execute\",\n                        inputs: [\"botURL\"],\n                        outputs: [\"userID\", \"outputText\"]\n                    },\n                    \"restartChat\": {\n                        displayName: \"Restart Chat\",\n                        type: \"execute\",\n                        inputs: [\"botURL\"],\n                        outputs: [\"userID\", \"outputText\"]\n                    }\n                }\n            }\n        }\n    });\n}\n\nonexecute = async function ({ objectName, methodName, parameters, properties, configuration }): Promise<void> {\n    switch (objectName) {\n        case \"message\": await onexecuteMessage(methodName, properties, configuration); break;\n        default: throw new Error(\"The object \" + objectName + \" is not supported.\");\n    }\n}\n\nasync function onexecuteMessage(methodName: string, properties: SingleRecord, configuration: SingleRecord): Promise<void> {\n    switch (methodName) {\n        case \"postText\": await onexecutePostText(properties, configuration); break;\n        case \"startChat\":\n        case \"restartChat\":\n            await onexecuteStartChat(properties, configuration); break;\n        default: throw new Error(\"The method \" + methodName + \" is not supported.\");\n    }\n}\n\nfunction onexecutePostText(properties: SingleRecord, configuration: SingleRecord): Promise<void> {\n    return new Promise<void>((resolve, reject) => {\n        var body = {\n            'message': properties[\"inputText\"].toString()\n        };\n\n        var postURL = `${properties[\"botURL\"]}?user_id=${properties[\"userID\"]}`;\n\n        var xhr = new XMLHttpRequest();\n        xhr.onreadystatechange = function () {\n            try {\n                if (xhr.readyState !== 4) return;\n                if (xhr.status !== 200) throw new Error(\"Failed with status \" + xhr.status);\n\n                var obj = JSON.parse(xhr.responseText);\n                postResult({\n                    \"outputText\": obj.messages[0].message,\n                });\n                resolve();\n            } catch (e) {\n                reject()\n            }\n        };\n\n        xhr.open(\"POST\", postURL);\n\n        xhr.send(JSON.stringify(body));\n    });\n\n}\n\nfunction onexecuteStartChat(properties: SingleRecord, configuration: SingleRecord): Promise<void> {\n    return new Promise<void>((resolve, reject) => {\n        var body = {\n            'message': ''\n        };\n\n        var userID = `guest_${Date.now()}`;\n\n        var postURL = `${properties[\"botURL\"]}?user_id=${userID}`;\n\n        var xhr = new XMLHttpRequest();\n        xhr.onreadystatechange = function () {\n            try {\n                if (xhr.readyState !== 4) return;\n                if (xhr.status !== 200) throw new Error(\"Failed with status \" + xhr.status);\n\n                var obj = JSON.parse(xhr.responseText);\n                postResult({\n                    \"outputText\": obj.messages[0].message.toString(),\n                    \"userID\": userID\n                });\n                resolve();\n            } catch (e) {\n                reject()\n            }\n        };\n\n        xhr.open(\"POST\", postURL);\n\n        xhr.send(JSON.stringify(body));\n    });\n}"],"names":["metadata","systemName","displayName","description","configuration","ondescribe","async","postSchema","objects","properties","type","methods","inputs","outputs","onexecute","objectName","methodName","parameters","Promise","resolve","reject","body","toString","postURL","xhr","XMLHttpRequest","onreadystatechange","readyState","status","Error","obj","JSON","parse","responseText","postResult","messages","message","e","open","send","stringify","onexecutePostText","userID","Date","now","onexecuteStartChat","onexecuteMessage"],"mappings":"AAEAA,SAAW,CACPC,WAAY,oBACZC,YAAa,oBACbC,YAAa,oBACbC,cAAe,IAGnBC,WAAaC,mBACTC,WAAW,CACPC,QAAS,SACM,CACPN,YAAa,UACbC,YAAa,yBACbM,WAAY,QACE,CACNP,YAAa,UACbQ,KAAM,oBAEG,CACTR,YAAa,aACbQ,KAAM,qBAEI,CACVR,YAAa,cACbQ,KAAM,iBAEA,CACNR,YAAa,UACbQ,KAAM,WAGdC,QAAS,UACO,CACRT,YAAa,YACbQ,KAAM,UACNE,OAAQ,CAAC,SAAU,YAAa,UAChCC,QAAS,CAAC,yBAED,CACTX,YAAa,aACbQ,KAAM,UACNE,OAAQ,CAAC,UACTC,QAAS,CAAC,SAAU,2BAET,CACXX,YAAa,eACbQ,KAAM,UACNE,OAAQ,CAAC,UACTC,QAAS,CAAC,SAAU,qBAQ5CC,UAAYR,gBAAgBS,WAAEA,EAAFC,WAAcA,EAAdC,WAA0BA,EAA1BR,WAAsCA,EAAtCL,cAAkDA,WAClEW,OACC,gBAKbT,eAAgCU,EAAoBP,EAA0BL,UAClEY,OACC,iBAQb,SAA2BP,EAA0BL,UAC1C,IAAIc,QAAc,CAACC,EAASC,SAC3BC,EAAO,SACIZ,EAAU,UAAca,YAGnCC,EAAW,GAAEd,EAAU,kBAAsBA,EAAU,SAEvDe,EAAM,IAAIC,eACdD,EAAIE,mBAAqB,kBAEM,IAAnBF,EAAIG,WAAkB,UACP,MAAfH,EAAII,OAAgB,MAAM,IAAIC,MAAM,sBAAwBL,EAAII,YAEhEE,EAAMC,KAAKC,MAAMR,EAAIS,cACzBC,WAAW,YACOJ,EAAIK,SAAS,GAAGC,UAElCjB,IACF,MAAOkB,GACLjB,MAIRI,EAAIc,KAAK,OAAQf,GAEjBC,EAAIe,KAAKR,KAAKS,UAAUnB,MAlCDoB,CAAkBhC,aACpC,gBACA,oBAqCb,SAA4BA,EAA0BL,UAC3C,IAAIc,QAAc,CAACC,EAASC,SAC3BC,EAAO,SACI,IAGXqB,EAAU,SAAQC,KAAKC,MAEvBrB,EAAW,GAAEd,EAAU,kBAAsBiC,IAE7ClB,EAAM,IAAIC,eACdD,EAAIE,mBAAqB,kBAEM,IAAnBF,EAAIG,WAAkB,UACP,MAAfH,EAAII,OAAgB,MAAM,IAAIC,MAAM,sBAAwBL,EAAII,YAEhEE,EAAMC,KAAKC,MAAMR,EAAIS,cACzBC,WAAW,YACOJ,EAAIK,SAAS,GAAGC,QAAQd,kBAC5BoB,IAEdvB,IACF,MAAOkB,GACLjB,MAIRI,EAAIc,KAAK,OAAQf,GAEjBC,EAAIe,KAAKR,KAAKS,UAAUnB,MAjEdwB,CAAmBpC,uBACd,IAAIoB,MAAM,cAAgBb,EAAa,uBAXhC8B,CAAiB9B,EAAYP,uBACpC,IAAIoB,MAAM,cAAgBd,EAAa"}