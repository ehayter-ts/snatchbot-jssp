{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["import '@k2oss/k2-broker-core';\n\nmetadata = {\n    systemName: \"SnatchBot_ChatBot\",\n    displayName: \"SnatchBot ChatBot\",\n    description: \"SnatchBot ChatBot\",\n    configuration: {\n        \"BotURL\": {\n            displayName: \"Bot URL\",\n            type: \"string\",\n            value: \"https://account.snatchbot.me/channels/api/api/id138553/app1/aps9725afca-a9f2-439c-80be-80f6b22cb4d2\"\n        }\n    }\n};\n\nondescribe = async function ({ }): Promise<void> {\n    postSchema({\n        objects: {\n            \"message\": {\n                displayName: \"Message\",\n                description: \"Represent a text reply\",\n                properties: {\n                    \"inputText\": {\n                        displayName: \"Input Text\",\n                        type: \"string\"\n                    },\n                    \"outputText\": {\n                        displayName: \"Output Text\",\n                        type: \"string\"\n                    },\n                    \"userID\": {\n                        displayName: \"User ID\",\n                        type: \"string\"\n                    }\n                },\n                methods: {\n                    \"postText\": {\n                        displayName: \"Post Text\",\n                        type: \"execute\",\n                        inputs: [\"inputText\", \"userID\"],\n                        outputs: [\"outputText\"]\n                    },\n                    \"startChat\": {\n                        displayName: \"Start Chat\",\n                        type: \"execute\",\n                        inputs: [],\n                        outputs: [\"userID\", \"outputText\"]\n                    },\n                    \"restartChat\": {\n                        displayName: \"Restart Chat\",\n                        type: \"execute\",\n                        inputs: [],\n                        outputs: [\"userID\", \"outputText\"]\n                    }\n                }\n            }\n        }\n    });\n}\n\nonexecute = async function ({ objectName, methodName, parameters, properties, configuration }): Promise<void> {\n    switch (objectName) {\n        case \"message\": await onexecuteMessage(methodName, properties, configuration); break;\n        default: throw new Error(\"The object \" + objectName + \" is not supported.\");\n    }\n}\n\nasync function onexecuteMessage(methodName: string, properties: SingleRecord, configuration: SingleRecord): Promise<void> {\n    switch (methodName) {\n        case \"postText\": await onexecutePostText(properties, configuration); break;\n        case \"startChat\":\n        case \"restartChat\":\n            await onexecuteStartChat(properties, configuration); break;\n        default: throw new Error(\"The method \" + methodName + \" is not supported.\");\n    }\n}\n\nfunction onexecutePostText(properties: SingleRecord, configuration: SingleRecord): Promise<void> {\n    return new Promise<void>((resolve, reject) => {\n        var body = {\n            'message': properties[\"inputText\"].toString()\n        };\n\n        var postURL = `${configuration[\"BotURL\"]}?user_id=${properties[\"userID\"]}`;\n\n        var xhr = new XMLHttpRequest();\n        xhr.onreadystatechange = function () {\n            try {\n                if (xhr.readyState !== 4) return;\n                if (xhr.status !== 200) throw new Error(\"Failed with status \" + xhr.status);\n\n                var obj = JSON.parse(xhr.responseText);\n                postResult({\n                    \"outputText\": obj.messages[0].message,\n                });\n                resolve();\n            } catch (e) {\n                reject()\n            }\n        };\n\n        xhr.open(\"POST\", postURL);\n\n        xhr.send(JSON.stringify(body));\n    });\n\n}\n\nfunction onexecuteStartChat(properties: SingleRecord, configuration: SingleRecord): Promise<void> {\n    return new Promise<void>((resolve, reject) => {\n        var body = {\n            'message': ''\n        };\n\n        var userID = `guest_${Date.now()}`;\n\n        var postURL = `${configuration[\"BotURL\"]}?user_id=${userID}`;\n\n        var xhr = new XMLHttpRequest();\n        xhr.onreadystatechange = function () {\n            try {\n                if (xhr.readyState !== 4) return;\n                if (xhr.status !== 200) throw new Error(\"Failed with status \" + xhr.status);\n\n                var obj = JSON.parse(xhr.responseText);\n                postResult({\n                    \"outputText\": JSON.stringify(obj),\n                    \"userID\": userID\n                });\n                resolve();\n            } catch (e) {\n                reject()\n            }\n        };\n\n        xhr.open(\"POST\", postURL);\n\n        xhr.send(JSON.stringify(body));\n    });\n}"],"names":["metadata","systemName","displayName","description","configuration","type","value","ondescribe","async","postSchema","objects","properties","methods","inputs","outputs","onexecute","objectName","methodName","parameters","Promise","resolve","reject","body","toString","postURL","xhr","XMLHttpRequest","onreadystatechange","readyState","status","Error","obj","JSON","parse","responseText","postResult","messages","message","e","open","send","stringify","onexecutePostText","userID","Date","now","onexecuteStartChat","onexecuteMessage"],"mappings":"AAEAA,SAAW,CACPC,WAAY,oBACZC,YAAa,oBACbC,YAAa,oBACbC,cAAe,QACD,CACNF,YAAa,UACbG,KAAM,SACNC,MAAO,yGAKnBC,WAAaC,mBACTC,WAAW,CACPC,QAAS,SACM,CACPR,YAAa,UACbC,YAAa,yBACbQ,WAAY,WACK,CACTT,YAAa,aACbG,KAAM,qBAEI,CACVH,YAAa,cACbG,KAAM,iBAEA,CACNH,YAAa,UACbG,KAAM,WAGdO,QAAS,UACO,CACRV,YAAa,YACbG,KAAM,UACNQ,OAAQ,CAAC,YAAa,UACtBC,QAAS,CAAC,yBAED,CACTZ,YAAa,aACbG,KAAM,UACNQ,OAAQ,GACRC,QAAS,CAAC,SAAU,2BAET,CACXZ,YAAa,eACbG,KAAM,UACNQ,OAAQ,GACRC,QAAS,CAAC,SAAU,qBAQ5CC,UAAYP,gBAAgBQ,WAAEA,EAAFC,WAAcA,EAAdC,WAA0BA,EAA1BP,WAAsCA,EAAtCP,cAAkDA,WAClEY,OACC,gBAKbR,eAAgCS,EAAoBN,EAA0BP,UAClEa,OACC,iBAQb,SAA2BN,EAA0BP,UAC1C,IAAIe,QAAc,CAACC,EAASC,SAC3BC,EAAO,SACIX,EAAU,UAAcY,YAGnCC,EAAW,GAAEpB,EAAa,kBAAsBO,EAAU,SAE1Dc,EAAM,IAAIC,eACdD,EAAIE,mBAAqB,kBAEM,IAAnBF,EAAIG,WAAkB,UACP,MAAfH,EAAII,OAAgB,MAAM,IAAIC,MAAM,sBAAwBL,EAAII,YAEhEE,EAAMC,KAAKC,MAAMR,EAAIS,cACzBC,WAAW,YACOJ,EAAIK,SAAS,GAAGC,UAElCjB,IACF,MAAOkB,GACLjB,MAIRI,EAAIc,KAAK,OAAQf,GAEjBC,EAAIe,KAAKR,KAAKS,UAAUnB,MAlCDoB,CAAkB/B,EAAYP,aAChD,gBACA,oBAqCb,SAA4BO,EAA0BP,UAC3C,IAAIe,QAAc,CAACC,EAASC,SAC3BC,EAAO,SACI,IAGXqB,EAAU,SAAQC,KAAKC,MAEvBrB,EAAW,GAAEpB,EAAa,kBAAsBuC,IAEhDlB,EAAM,IAAIC,eACdD,EAAIE,mBAAqB,kBAEM,IAAnBF,EAAIG,WAAkB,UACP,MAAfH,EAAII,OAAgB,MAAM,IAAIC,MAAM,sBAAwBL,EAAII,YAEhEE,EAAMC,KAAKC,MAAMR,EAAIS,cACzBC,WAAW,YACOH,KAAKS,UAAUV,UACnBY,IAEdvB,IACF,MAAOkB,GACLjB,MAIRI,EAAIc,KAAK,OAAQf,GAEjBC,EAAIe,KAAKR,KAAKS,UAAUnB,MAjEdwB,CAAmBnC,EAAYP,uBAC1B,IAAI0B,MAAM,cAAgBb,EAAa,uBAXhC8B,CAAiB9B,EAAYN,EAAYP,uBAChD,IAAI0B,MAAM,cAAgBd,EAAa"}